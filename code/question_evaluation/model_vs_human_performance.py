# -*- coding: utf-8 -*-
"""human_performance.ipynb

Automatically generated by Colab.

"""

import pandas as pd
import json
from google.colab import files

# Upload the files
uploaded = files.upload()

# Load the dataframe from the CSV file
csv_filename = 'questions_with_answers.csv'  # CSV of the questions which humans answered
df = pd.read_csv(csv_filename)

# Load the JSON model outputs
json_filename = 'medcalcqa_gpt-4o.json'  # Example model performance
with open(json_filename, 'r') as f:
    model_outputs = json.load(f)

# Convert the JSON keys to strings with zero-padded format to match the dataframe
model_outputs = {f"{int(k):04d}": v for k, v in model_outputs.items()}

# Create a new dataframe from the JSON model outputs
model_df = pd.DataFrame.from_dict(model_outputs, orient='index')
model_df.reset_index(inplace=True)
model_df.rename(columns={'index': 'id'}, inplace=True)

# Ensure the ids in the original dataframe are zero-padded
df['id'] = df['id'].apply(lambda x: f"{int(x):04d}")

# Merge the two dataframes on the 'id' column
merged_df = pd.merge(df, model_df, on='id', how='inner')

# Check the accuracy of the 'answer' key in the JSON file compared to the 'Answer' column in the dataframe
merged_df['is_correct'] = merged_df['Answer'] == merged_df['answer']

# Filter the mismatches
mismatches = merged_df[~merged_df['is_correct']]

# Print the questions and answers where there was a mismatch
if not mismatches.empty:
    print("Questions and answers where there was a mismatch:")
    for _, row in mismatches.iterrows():
        print(f"ID: {row['id']}")
        print(f"Question: {row['Question']}")
        print(f"Note: {row['Note']}")
        print(f"Model Answer: {row['answer']}")
        print(f"Actual Answer: {row['Answer']}")
        print(f"Explanation: {row['explanation']}\n")
else:
    print("No mismatches found.")

# Display the accuracy
accuracy = merged_df['is_correct'].mean()

# Accuracy of GPT-4o model on questions (~0.70 in this case)
print(accuracy)

# Example performances from medical students
"""SA Accuracy: 33/36 = 0.916, AG Accuracy: 26/36 = 0.722"""